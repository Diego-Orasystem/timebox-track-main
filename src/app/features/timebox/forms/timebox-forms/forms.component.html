<form
  [formGroup]="form"
  class="px-3 pt-6 flex flex-col place-content-between h-fit"
>
  <ng-container [ngSwitch]="currentStepIndex">
    <app-planning
      formGroupName="planning"
      #stepComponent
      *ngSwitchCase="0"
      (autoSaveRequest)="handleTimeboxSaveRequest($event)"
    ></app-planning>
    <app-kickoff
      formGroupName="kickOff"
      #stepComponent
      *ngSwitchCase="1"
      (autoSaveRequest)="handleTimeboxSaveRequest($event)"
    ></app-kickoff>
    <app-refinement
      [timeboxData]="timeboxData"
      formGroupName="refinement"
      #stepComponent
      *ngSwitchCase="2"
    ></app-refinement>
    <app-qa formGroupName="qa" #stepComponent *ngSwitchCase="3"></app-qa>
         <app-close
       [timeboxId]="getTimeboxId()"
       formGroupName="close"
       #stepComponent
       *ngSwitchCase="4"
     ></app-close>
  </ng-container>

  <!-- Mensajes de Error de Validaci√≥n -->
  <div *ngIf="currentStepIndex === 0" class="mb-4 p-4 border rounded-md" 
       [class]="!isPlanningValid() ? 'bg-red-50 border-red-200' : 'bg-green-50 border-green-200'">
    <div class="flex items-center justify-between">
      <div class="flex items-center">
        <svg *ngIf="!isPlanningValid()" class="w-5 h-5 text-red-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
        </svg>
        <svg *ngIf="isPlanningValid()" class="w-5 h-5 text-green-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" clip-rule="evenodd"></path>
        </svg>
        <h3 class="text-sm font-medium" [class]="!isPlanningValid() ? 'text-red-800' : 'text-green-800'">
          {{ !isPlanningValid() ? 'Campos obligatorios pendientes' : 'Formulario v√°lido' }}
        </h3>
      </div>
      <button 
        (click)="validatePlanningForm()" 
        type="button"
        class="text-xs px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-gray-700"
        title="Forzar validaci√≥n">
        üîç Validar
      </button>
    </div>
    
    <div class="mt-2 text-sm" [class]="!isPlanningValid() ? 'text-red-700' : 'text-green-700'">
      <div *ngIf="!isPlanningValid()">
        <p>Por favor, completa los siguientes campos obligatorios antes de continuar:</p>
        <ul class="mt-2 list-disc list-inside">
          <li *ngFor="let error of getPlanningErrors() | keyvalue">
            <strong>{{ getFieldDisplayName(error.key) }}:</strong> {{ error.value }}
          </li>
          <li *ngIf="(getPlanningErrors() | keyvalue)?.length === 0">
            <em>No se detectaron errores espec√≠ficos. Revisa la consola para m√°s detalles.</em>
          </li>
        </ul>
      </div>
      <div *ngIf="isPlanningValid()">
        <p>‚úÖ Todos los campos obligatorios est√°n completados correctamente.</p>
      </div>
    </div>
  </div>
  


  <!--Botones-->
  <div class="buttons inline-flex items-end place-content-end space-x-4">
    <button
      (click)="handleCompletarPaso()"
      type="button"
      [disabled]="currentStepIndex === 0 && !isPlanningValid()"
      class="px-4 py-3 text-[12px] font-medium text-white bg-[var(--primary)] rounded-sm hover:bg-[var(--primaryDark)] focus:outline-none cursor-pointer duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
      *ngIf="currentStepIndex < steps.length"
    >
      <ng-container [ngSwitch]="buttonText()">
        <ng-container *ngSwitchCase="'Guardar Timebox'"
          >Guardar Timebox</ng-container
        >
        <ng-container *ngSwitchCase="'Guardar y Publicar'"
          >Guardar y Publicar</ng-container
        >
        <ng-container *ngSwitchCase="'Guardar Cambios'"
          >Guardar Cambios</ng-container
        >
        <ng-container *ngSwitchCase="'Completar Timebox'"
          >Completar Timebox</ng-container
        >
        <ng-container *ngSwitchCase="'Completar Fase'"
          >Completar Fase</ng-container
        >
      </ng-container>
    </button>
  </div>
</form>

<!--Modal-->

<div
  *ngIf="showConfirmModal"
  class="fixed inset-0 flex items-center justify-center z-50"
>
  <div
    class="absolute inset-0 bg-black opacity-30 backdrop-blur-lg"
    (click)="cancelConfirmation()"
  ></div>

  <div class="card" *ngIf="showConfirmModal">
    <p class="titleHeading">
      <ng-container [ngSwitch]="phaseToConfirmName">
        <ng-container *ngSwitchCase="'planning-create'"
          >Guardar timebox</ng-container
        >
        <ng-container *ngSwitchCase="'kickoff-publish-only'"
          >Confirmar Publicaci√≥n</ng-container
        >
        <ng-container *ngSwitchCase="'kickoff-publish-and-complete'"
          >Confirmar Completar Etapa</ng-container
        >
        <ng-container *ngSwitchCase="'close'"
          >Confirmar Completar Timebox</ng-container
        >
        <ng-container *ngSwitchDefault>Confirmar Completar Etapa</ng-container>
      </ng-container>
    </p>
    <p class="modalDescription">
      <ng-container [ngSwitch]="phaseToConfirmName">
        <ng-container *ngSwitchCase="'planning-create'"
          >Confirma para crear un nuevo timebox</ng-container
        >
        <ng-container *ngSwitchCase="'kickoff-publish-only'"
          >Algunos roles del equipo no han sido asignados.
          <span class="font-semibold"
            >¬øEst√°s seguro de que deseas publicar este Timebox como
            disponible?</span
          ></ng-container
        >
        <ng-container *ngSwitchDefault
          >¬øEst√°s seguro de que deseas marcar la etapa "<span
            class="font-semibold capitalize"
            >{{ phaseToConfirmName }}</span
          >" como completada? Una vez completada, los cambios ser√°n
          guardados.</ng-container
        >
        <ng-container *ngSwitchCase="'close'"
          ><span class="font-semibold"
            >¬øEst√°s seguro que deseas completar el Timebox? Una vez confirmado,
            se realizar√°n
            <b>las ordenes de cobro para el equipo colaborador.</b>
          </span></ng-container
        >
      </ng-container>
    </p>

    <div class="buttonContainer">
      <button
        class="px-4 py-2 text-sm font-medium text-white bg-[var(--primary)] rounded-sm hover:bg-[var(--primaryDark)] focus:outline-none cursor-pointer"
        (click)="confirmCompletion()"
      >
        <ng-container [ngSwitch]="phaseToConfirmName">
          <ng-container *ngSwitchCase="'planning-create'">Guardar</ng-container>
          <ng-container *ngSwitchCase="'kickoff-publish-only'"
            >Publicar</ng-container
          >
          <ng-container *ngSwitchDefault>Completar</ng-container>
        </ng-container>
      </button>
      <button
        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-sm hover:bg-gray-300 focus:outline-none cursor-pointer"
        (click)="cancelConfirmation()"
      >
        Cancelar
      </button>
    </div>
  </div>
</div>

<style>
  /* From Uiverse.io by 00Kubi */
  .card {
    width: 350px;
    height: 220px;
    background-color: rgb(255, 255, 255);
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px 30px;
    gap: 13px;
    position: relative;
    overflow: hidden;
    box-shadow: 2px 2px 20px rgba(0, 0, 0, 0.062);
  }

  .titleHeading {
    font-size: 1.2em;
    font-weight: 800;
    color: rgb(26, 26, 26);
  }

  .modalDescription {
    text-align: center;
    font-size: 0.7em;
    font-weight: 600;
    color: rgb(99, 99, 99);
  }

  .modalDescription a {
    --tw-text-opacity: 1;
    color: rgb(59 130 246);
  }

  .modalDescription a:hover {
    -webkit-text-decoration-line: underline;
    text-decoration-line: underline;
  }

  .buttonContainer {
    display: flex;
    gap: 20px;
    flex-direction: row;
  }
</style>
